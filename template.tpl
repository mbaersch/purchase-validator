___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Purchase Validator",
  "categories": [
    "UTILITY"
  ],
  "brand": {
    "id": "mbaersch",
    "displayName": "mbaersch",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Finds the latest purchase dataLayer event and validates against GA4 specifications, then pushes results to dataLayer. Optional size check.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "gOptions",
    "displayName": "Options",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "forceValue",
        "checkboxText": "Value required",
        "simpleValueType": true,
        "help": "Check if a purchase without a value should raise an error (a value of 0 will still be accepted).",
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "doWarnings",
        "checkboxText": "Activate Warnings",
        "simpleValueType": true,
        "help": "If warnings are active, the result will contain info about missing recommended fields like price or quanitity and inform about wrong value types (string instead of integer / number)"
      },
      {
        "type": "CHECKBOX",
        "name": "informConsole",
        "checkboxText": "Log Result To Console",
        "simpleValueType": true,
        "help": "Results will be pushed to the dataLayer. Optionally get informed in the browser console, too."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "gSize",
    "displayName": "Check size",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "checkSizeLimit",
        "displayName": "Size Limit (0\u003doff)",
        "simpleValueType": true,
        "defaultValue": 0,
        "valueValidators": [
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ],
        "help": "Enter a positive integer as limit (in bytes)"
      }
    ],
    "help": "You can optionally define a size limit for the ecommerce object. Even if this does not reflect actual GA4 request payload size, you can use this option if you suspect problems caused by large payloads (e. g. from custom product dimension values)."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const getType = require("getType");
const makeNumber = require("makeNumber");
const makeString = require("makeString");
const JSON = require('JSON');
const dlcopy = require('copyFromWindow')('dataLayer'), doWarn = data.doWarnings;

var messages = [], warnings = [],
    purchaseEvent = null,
    trans_id = "<NONE>",
    chType,
    didQtyW = false, didQtyE = false, 
    didPrcW = false, didPrcE = false;

//this is not perfect but should catch real problems
const isValidFloat = function(str){
  var tp = getType(str);
  if (tp === "number") return true;
  if (tp === "string") {
    var nm = makeNumber(str);
    return makeString(nm) === str;
  }
  return false;    
};

const getTypeInfo = function(x){
  let tp = getType(x);
  if (tp === "null") tp = "undefined"; 
  if (tp === "string") {
    let xv = x.toLowerCase().trim();
    if ((xv === "") || (xv === "null") || (xv === "undefined")) tp = "undefined";
  } 
  return tp;
};


//find (last) purchase event
for (var i = dlcopy.length - 1; i >= 0; i--) {
  if (dlcopy[i] && dlcopy[i].event === 'purchase') {
    purchaseEvent = dlcopy[i];
    break;
  }
}

if (!purchaseEvent) {
  messages.push("no purchase event");
} else {
  var ecommerce = purchaseEvent.ecommerce;

  //field falidation
  if (!ecommerce) {
    messages.push("no ecommerce object");
  } else {
    if (!ecommerce.transaction_id) messages.push("no transaction_id");
    else trans_id = ecommerce.transaction_id;
    chType = getTypeInfo(ecommerce.value);
    if (chType === "undefined") {
      if (data.forceValue) messages.push("no value");
    } else if (chType !== "number") {
      if (!ecommerce.currency) messages.push("no currency");
      if (doWarn) warnings.push("value not numeric");
      if (!isValidFloat(ecommerce.value)) messages.push("value incorrect string");      
    }
    if (getType(ecommerce.items) != "array") {
      messages.push("no items");
    } else {

      // check items
      if (ecommerce.items.length == 0)
        messages.push("empty items");
      else ecommerce.items.forEach(function(item, idx) {
        if (!item.item_id && !item.item_name) {
          messages.push("no item_id or item_name");
        }
        chType = getTypeInfo(item.quantity);
        if (chType === "undefined") {
          if (doWarn && !didQtyW) {
            warnings.push("no item quantity");
            didQtyW = true;
          }
        } else if (chType !== "number") {
          if (doWarn && !didQtyW) {
            warnings.push("item quantity not numeric");
            didQtyW = true;
          }
          if (!isValidFloat(item.quantity)) { 
            if (!didQtyE) messages.push("item quantity incorrect string");      
            didQtyE = true;
          }
        }
        chType = getTypeInfo(item.price);
        if (chType === "undefined") {
          if (doWarn && !didPrcW) {
            warnings.push("no item price");
            didPrcW = true;
          }
        } else if (chType !== "number") {
          if (doWarn && !didPrcW) {
            warnings.push("item price not numeric");
            didPrcW = true;
          }
          if (!isValidFloat(item.price)) { 
            if (!didPrcE) messages.push("item price incorrect string");      
            didPrcE = true;
          }
        }
      });
    }
  }

  // simple size check
  if (data.checkSizeLimit > 0) {
    var size = JSON.stringify(purchaseEvent.ecommerce).length;
    if (size > data.checkSizeLimit) {
      messages.push("size exceeds limit");
    }
  }
}

var checkRes = messages.length > 0 ? "error" : (warnings.length > 0 ? "warning" : "success");
var resultObj = {
  event: "purchase_validation",
  check_results: {
    result_type: checkRes,
    transaction_id: trans_id,
    errors: messages.length,
    errorText: messages ? messages.join(", ") : ""
  }
};
if (doWarn) {
  resultObj.check_results.warnings = warnings.length;
  resultObj.check_results.warningText = warnings ? warnings.join(", ") : "";
}

if (data.informConsole) require("logToConsole")("Purchase validation results", resultObj);
require("createQueue")('dataLayer')(resultObj);
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 20.9.2025, 15:26:14


